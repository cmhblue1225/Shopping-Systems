<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³ ê°ê´€ë¦¬ì‹œìŠ¤í…œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .container { max-width: 1300px; margin: 0 auto; padding: 20px; }
        .header { background: #8e44ad; color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .stat-value { font-size: 28px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { color: #7f8c8d; font-size: 14px; }
        .vip { color: #f39c12; }
        .regular { color: #3498db; }
        .new { color: #27ae60; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .search-box { padding: 10px; border: 1px solid #ddd; border-radius: 5px; flex: 1; max-width: 250px; }
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        .table th, .table td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #ddd; }
        .table th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; }
        .grade-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .nav-home { position: fixed; top: 20px; right: 20px; background: #3498db; color: white; padding: 10px 15px; border-radius: 25px; text-decoration: none; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 3% auto; padding: 20px; width: 90%; max-width: 600px; border-radius: 8px; max-height: 85vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .notification { position: fixed; top: 80px; right: 20px; padding: 15px 20px; border-radius: 5px; color: white; z-index: 1001; display: none; min-width: 250px; }
        .notification.success { background: #27ae60; }
        .notification.error { background: #e74c3c; }
        .notification.info { background: #3498db; }
        .customer-detail { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .purchase-history { max-height: 200px; overflow-y: auto; }
        .tab-container { margin-bottom: 20px; }
        .tab-buttons { display: flex; background: #f8f9fa; border-radius: 8px; padding: 5px; }
        .tab-button { flex: 1; padding: 10px; border: none; background: none; cursor: pointer; border-radius: 5px; transition: all 0.3s; }
        .tab-button.active { background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .controls { flex-direction: column; align-items: stretch; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <a href="../integrated-system/" class="nav-home">ğŸ  í†µí•© ëŒ€ì‹œë³´ë“œ</a>
    
    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ‘¥ ê³ ê°ê´€ë¦¬ì‹œìŠ¤í…œ</h1>
                <p>ê³ ê° ì •ë³´ ë° êµ¬ë§¤ ì´ë ¥ í†µí•© ê´€ë¦¬</p>
            </div>
            <div>
                <button class="btn btn-success" onclick="openCustomerModal()">+ ì‹ ê·œ ê³ ê°</button>
                <button class="btn btn-info" onclick="exportCustomers()">ğŸ“Š ê³ ê° ë¦¬í¬íŠ¸</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalCustomers">0</div>
                <div class="stat-label">ì´ ê³ ê° ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-value vip" id="vipCustomers">0</div>
                <div class="stat-label">VIP ê³ ê°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value new" id="newCustomers">0</div>
                <div class="stat-label">ì´ë‹¬ ì‹ ê·œ ê³ ê°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgPurchase">â‚©0</div>
                <div class="stat-label">í‰ê·  êµ¬ë§¤ ê¸ˆì•¡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value regular" id="activeCustomers">0</div>
                <div class="stat-label">í™œì„± ê³ ê°</div>
            </div>
        </div>

        <div class="section">
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('all')">ì „ì²´ ê³ ê°</button>
                    <button class="tab-button" onclick="switchTab('vip')">VIP</button>
                    <button class="tab-button" onclick="switchTab('regular')">ì¼ë°˜</button>
                    <button class="tab-button" onclick="switchTab('new')">ì‹ ê·œ</button>
                    <button class="tab-button" onclick="switchTab('inactive')">ë¹„í™œì„±</button>
                </div>
            </div>

            <div class="controls">
                <input type="text" class="search-box" placeholder="ì´ë¦„, ì „í™”ë²ˆí˜¸, ì´ë©”ì¼ë¡œ ê²€ìƒ‰..." id="searchInput">
                <select id="gradeFilter" class="search-box" style="max-width: 120px;">
                    <option value="">ì „ì²´ ë“±ê¸‰</option>
                    <option value="VIP">VIP</option>
                    <option value="GOLD">GOLD</option>
                    <option value="SILVER">SILVER</option>
                    <option value="BRONZE">BRONZE</option>
                </select>
                <select id="regionFilter" class="search-box" style="max-width: 120px;">
                    <option value="">ì „ì²´ ì§€ì—­</option>
                    <option value="ì„œìš¸">ì„œìš¸</option>
                    <option value="ê²½ê¸°">ê²½ê¸°</option>
                    <option value="ì¸ì²œ">ì¸ì²œ</option>
                    <option value="ë¶€ì‚°">ë¶€ì‚°</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
                <button class="btn btn-primary" onclick="refreshCustomers()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <div style="max-height: 600px; overflow-y: auto;">
                <table class="table" id="customersTable">
                    <thead>
                        <tr>
                            <th>ê³ ê°ë²ˆí˜¸</th>
                            <th>ì´ë¦„</th>
                            <th>ì—°ë½ì²˜</th>
                            <th>ì´ë©”ì¼</th>
                            <th>ë“±ê¸‰</th>
                            <th>ê°€ì…ì¼</th>
                            <th>ì´ êµ¬ë§¤ì•¡</th>
                            <th>êµ¬ë§¤íšŸìˆ˜</th>
                            <th>ìµœê·¼êµ¬ë§¤</th>
                            <th>ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody id="customersTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ê³ ê° ì •ë³´ ëª¨ë‹¬ -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">ì‹ ê·œ ê³ ê° ë“±ë¡</h3>
            <form id="customerForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>ì´ë¦„ *</label>
                        <input type="text" id="customerName" required>
                    </div>
                    <div class="form-group">
                        <label>ì—°ë½ì²˜ *</label>
                        <input type="tel" id="customerPhone" required>
                    </div>
                    <div class="form-group">
                        <label>ì´ë©”ì¼</label>
                        <input type="email" id="customerEmail">
                    </div>
                    <div class="form-group">
                        <label>ìƒë…„ì›”ì¼</label>
                        <input type="date" id="customerBirth">
                    </div>
                    <div class="form-group">
                        <label>ì„±ë³„</label>
                        <select id="customerGender">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="M">ë‚¨ì„±</option>
                            <option value="F">ì—¬ì„±</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ê³ ê°ë“±ê¸‰</label>
                        <select id="customerGrade">
                            <option value="BRONZE">BRONZE</option>
                            <option value="SILVER">SILVER</option>
                            <option value="GOLD">GOLD</option>
                            <option value="VIP">VIP</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ì£¼ì†Œ</label>
                    <textarea id="customerAddress" rows="2" placeholder="ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>
                
                <div class="form-group">
                    <label>ë©”ëª¨</label>
                    <textarea id="customerMemo" rows="3" placeholder="ê³ ê° ê´€ë ¨ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>

                <div class="controls" style="margin-top: 20px;">
                    <button type="submit" class="btn btn-success">ì €ì¥</button>
                    <button type="button" class="btn" onclick="closeCustomerModal()">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ê³ ê° ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
    <div id="customerDetailModal" class="modal">
        <div class="modal-content">
            <h3>ê³ ê° ìƒì„¸ ì •ë³´</h3>
            <div id="customerDetailContent">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
            <div class="controls" style="margin-top: 20px;">
                <button type="button" class="btn btn-primary" onclick="editCustomer()">ìˆ˜ì •</button>
                <button type="button" class="btn" onclick="closeDetailModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <!-- í†µí•© ì‹œìŠ¤í…œ ì—°ë™ -->
    <script src="../integrated-system/core/data-manager.js"></script>
    <script src="../integrated-system/core/schema-manager.js"></script>
    <script src="../integrated-system/adapters/legacy-integration.js"></script>
    
    <script>
        class CustomerManagementSystem {
            constructor() {
                this.dataManager = window.DataManager;
                this.currentTab = 'all';
                this.currentCustomer = null;
                this.init();
            }

            init() {
                this.generateSampleCustomers();
                this.setupEventListeners();
                this.updateStats();
                this.renderCustomers();
            }

            generateSampleCustomers() {
                const customers = this.dataManager.getData('customers') || [];
                if (customers.length === 0) {
                    const grades = ['BRONZE', 'SILVER', 'GOLD', 'VIP'];
                    const regions = ['ì„œìš¸', 'ê²½ê¸°', 'ì¸ì²œ', 'ë¶€ì‚°', 'ê¸°íƒ€'];
                    const genders = ['M', 'F'];
                    const sampleCustomers = [];

                    // ì£¼ë¬¸ ë°ì´í„°ì—ì„œ ê³ ê° ì •ë³´ ìƒì„±
                    const orders = this.dataManager.getData('orders') || [];
                    const uniqueCustomers = new Map();

                    orders.forEach(order => {
                        if (!uniqueCustomers.has(order.customerName)) {
                            uniqueCustomers.set(order.customerName, {
                                name: order.customerName,
                                phone: order.customerPhone,
                                email: order.customerEmail,
                                totalAmount: order.totalAmount,
                                orderCount: 1,
                                lastOrderDate: order.orderDate
                            });
                        } else {
                            const customer = uniqueCustomers.get(order.customerName);
                            customer.totalAmount += order.totalAmount;
                            customer.orderCount += 1;
                            if (new Date(order.orderDate) > new Date(customer.lastOrderDate)) {
                                customer.lastOrderDate = order.orderDate;
                            }
                        }
                    });

                    // ê³ ê° ë°ì´í„° ìƒì„±
                    let customerId = 1;
                    uniqueCustomers.forEach((customerData, name) => {
                        const joinDate = new Date();
                        joinDate.setDate(joinDate.getDate() - Math.floor(Math.random() * 365));
                        
                        const birth = new Date();
                        birth.setFullYear(birth.getFullYear() - (Math.floor(Math.random() * 40) + 20));

                        // êµ¬ë§¤ì•¡ì— ë”°ë¥¸ ë“±ê¸‰ ê²°ì •
                        let grade = 'BRONZE';
                        if (customerData.totalAmount >= 1000000) grade = 'VIP';
                        else if (customerData.totalAmount >= 500000) grade = 'GOLD';
                        else if (customerData.totalAmount >= 200000) grade = 'SILVER';

                        sampleCustomers.push({
                            customerId: `CUST${String(customerId).padStart(6, '0')}`,
                            name: customerData.name,
                            phone: customerData.phone,
                            email: customerData.email,
                            gender: genders[Math.floor(Math.random() * genders.length)],
                            birth: birth.toISOString().split('T')[0],
                            grade: grade,
                            region: regions[Math.floor(Math.random() * regions.length)],
                            address: `${regions[Math.floor(Math.random() * regions.length)]} ${regions[Math.floor(Math.random() * regions.length)]}êµ¬ ${Math.floor(Math.random() * 900) + 100}ë²ˆê¸¸`,
                            joinDate: joinDate.toISOString(),
                            totalPurchase: customerData.totalAmount,
                            purchaseCount: customerData.orderCount,
                            lastPurchase: customerData.lastOrderDate,
                            isActive: Math.random() > 0.1,
                            memo: `${grade} ë“±ê¸‰ ê³ ê°`,
                            createdAt: joinDate.toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                        customerId++;
                    });

                    // ì¶”ê°€ ìƒ˜í”Œ ê³ ê° ìƒì„±
                    for (let i = customerId; i <= 100; i++) {
                        const joinDate = new Date();
                        joinDate.setDate(joinDate.getDate() - Math.floor(Math.random() * 365));
                        
                        const birth = new Date();
                        birth.setFullYear(birth.getFullYear() - (Math.floor(Math.random() * 40) + 20));

                        const totalPurchase = Math.floor(Math.random() * 500000);
                        const purchaseCount = Math.floor(Math.random() * 20);
                        
                        let grade = grades[Math.floor(Math.random() * grades.length)];

                        sampleCustomers.push({
                            customerId: `CUST${String(i).padStart(6, '0')}`,
                            name: `ê³ ê°${i}`,
                            phone: `010-${String(Math.floor(Math.random() * 9000) + 1000)}-${String(Math.floor(Math.random() * 9000) + 1000)}`,
                            email: `customer${i}@email.com`,
                            gender: genders[Math.floor(Math.random() * genders.length)],
                            birth: birth.toISOString().split('T')[0],
                            grade: grade,
                            region: regions[Math.floor(Math.random() * regions.length)],
                            address: `${regions[Math.floor(Math.random() * regions.length)]} ${regions[Math.floor(Math.random() * regions.length)]}êµ¬ ${Math.floor(Math.random() * 900) + 100}ë²ˆê¸¸`,
                            joinDate: joinDate.toISOString(),
                            totalPurchase: totalPurchase,
                            purchaseCount: purchaseCount,
                            lastPurchase: purchaseCount > 0 ? joinDate.toISOString() : null,
                            isActive: Math.random() > 0.15,
                            memo: `${grade} ë“±ê¸‰ ê³ ê°`,
                            createdAt: joinDate.toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                    }

                    this.dataManager.setData('customers', sampleCustomers);
                }
            }

            setupEventListeners() {
                document.getElementById('customerForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveCustomer();
                });

                document.getElementById('searchInput').addEventListener('input', () => this.renderCustomers());
                document.getElementById('gradeFilter').addEventListener('change', () => this.renderCustomers());
                document.getElementById('regionFilter').addEventListener('change', () => this.renderCustomers());
            }

            updateStats() {
                const customers = this.dataManager.getData('customers') || [];
                const thisMonth = new Date().toISOString().substring(0, 7);
                
                const total = customers.length;
                const vip = customers.filter(c => c.grade === 'VIP').length;
                const newThisMonth = customers.filter(c => c.joinDate.substring(0, 7) === thisMonth).length;
                const active = customers.filter(c => c.isActive).length;
                const avgPurchase = customers.length > 0 ? 
                    customers.reduce((sum, c) => sum + (c.totalPurchase || 0), 0) / customers.length : 0;

                document.getElementById('totalCustomers').textContent = total;
                document.getElementById('vipCustomers').textContent = vip;
                document.getElementById('newCustomers').textContent = newThisMonth;
                document.getElementById('activeCustomers').textContent = active;
                document.getElementById('avgPurchase').textContent = `â‚©${Math.round(avgPurchase).toLocaleString()}`;
            }

            getGradeBadge(grade) {
                const badges = {
                    VIP: '<span class="grade-badge" style="background:#e74c3c;color:white">VIP</span>',
                    GOLD: '<span class="grade-badge" style="background:#f39c12;color:white">GOLD</span>',
                    SILVER: '<span class="grade-badge" style="background:#95a5a6;color:white">SILVER</span>',
                    BRONZE: '<span class="grade-badge" style="background:#8b4513;color:white">BRONZE</span>'
                };
                return badges[grade] || badges.BRONZE;
            }

            renderCustomers() {
                const customers = this.dataManager.getData('customers') || [];
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const gradeFilter = document.getElementById('gradeFilter').value;
                const regionFilter = document.getElementById('regionFilter').value;

                let filtered = customers.filter(customer => {
                    const matchesSearch = customer.name.toLowerCase().includes(searchTerm) ||
                                        customer.phone.includes(searchTerm) ||
                                        customer.email.toLowerCase().includes(searchTerm);
                    const matchesGrade = !gradeFilter || customer.grade === gradeFilter;
                    const matchesRegion = !regionFilter || customer.region === regionFilter;
                    
                    const matchesTab = this.currentTab === 'all' ||
                                     (this.currentTab === 'vip' && customer.grade === 'VIP') ||
                                     (this.currentTab === 'regular' && customer.grade !== 'VIP') ||
                                     (this.currentTab === 'new' && new Date(customer.joinDate).getMonth() === new Date().getMonth()) ||
                                     (this.currentTab === 'inactive' && !customer.isActive);

                    return matchesSearch && matchesGrade && matchesRegion && matchesTab;
                });

                // ìµœì‹  ê°€ì… ìˆœìœ¼ë¡œ ì •ë ¬
                filtered.sort((a, b) => new Date(b.joinDate) - new Date(a.joinDate));

                const tbody = document.getElementById('customersTableBody');
                tbody.innerHTML = filtered.map(customer => `
                    <tr style="${!customer.isActive ? 'opacity: 0.6;' : ''}">
                        <td><strong>${customer.customerId}</strong></td>
                        <td>${customer.name}</td>
                        <td>${customer.phone}</td>
                        <td><small>${customer.email}</small></td>
                        <td>${this.getGradeBadge(customer.grade)}</td>
                        <td>${new Date(customer.joinDate).toLocaleDateString('ko-KR')}</td>
                        <td><strong>â‚©${(customer.totalPurchase || 0).toLocaleString()}</strong></td>
                        <td>${customer.purchaseCount || 0}íšŒ</td>
                        <td>${customer.lastPurchase ? new Date(customer.lastPurchase).toLocaleDateString('ko-KR') : '-'}</td>
                        <td>
                            <button class="btn btn-primary" style="padding:5px 8px;font-size:11px;margin:2px;" 
                                    onclick="customerSystem.viewCustomer('${customer.customerId}')">ìƒì„¸</button>
                            <button class="btn btn-warning" style="padding:5px 8px;font-size:11px;margin:2px;" 
                                    onclick="customerSystem.editCustomer('${customer.customerId}')">ìˆ˜ì •</button>
                        </td>
                    </tr>
                `).join('');
            }

            switchTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                this.renderCustomers();
            }

            viewCustomer(customerId) {
                const customers = this.dataManager.getData('customers') || [];
                const customer = customers.find(c => c.customerId === customerId);
                if (!customer) return;

                // êµ¬ë§¤ ì´ë ¥ ì¡°íšŒ
                const orders = this.dataManager.getData('orders') || [];
                const customerOrders = orders.filter(o => o.customerName === customer.name);

                const detailContent = `
                    <div class="customer-detail">
                        <h4>ê¸°ë³¸ ì •ë³´</h4>
                        <p><strong>ê³ ê°ë²ˆí˜¸:</strong> ${customer.customerId}</p>
                        <p><strong>ì´ë¦„:</strong> ${customer.name}</p>
                        <p><strong>ì—°ë½ì²˜:</strong> ${customer.phone}</p>
                        <p><strong>ì´ë©”ì¼:</strong> ${customer.email}</p>
                        <p><strong>ìƒë…„ì›”ì¼:</strong> ${customer.birth || '-'}</p>
                        <p><strong>ì„±ë³„:</strong> ${customer.gender === 'M' ? 'ë‚¨ì„±' : customer.gender === 'F' ? 'ì—¬ì„±' : '-'}</p>
                        <p><strong>ë“±ê¸‰:</strong> ${customer.grade}</p>
                        <p><strong>ì§€ì—­:</strong> ${customer.region}</p>
                        <p><strong>ì£¼ì†Œ:</strong> ${customer.address}</p>
                        <p><strong>ê°€ì…ì¼:</strong> ${new Date(customer.joinDate).toLocaleString('ko-KR')}</p>
                        <p><strong>ìƒíƒœ:</strong> ${customer.isActive ? 'í™œì„±' : 'ë¹„í™œì„±'}</p>
                        <p><strong>ë©”ëª¨:</strong> ${customer.memo || '-'}</p>
                    </div>
                    
                    <div class="customer-detail">
                        <h4>êµ¬ë§¤ í†µê³„</h4>
                        <p><strong>ì´ êµ¬ë§¤ì•¡:</strong> â‚©${(customer.totalPurchase || 0).toLocaleString()}</p>
                        <p><strong>êµ¬ë§¤ íšŸìˆ˜:</strong> ${customer.purchaseCount || 0}íšŒ</p>
                        <p><strong>í‰ê·  êµ¬ë§¤ì•¡:</strong> â‚©${customer.purchaseCount > 0 ? Math.round(customer.totalPurchase / customer.purchaseCount).toLocaleString() : '0'}</p>
                        <p><strong>ìµœê·¼ êµ¬ë§¤:</strong> ${customer.lastPurchase ? new Date(customer.lastPurchase).toLocaleString('ko-KR') : '-'}</p>
                    </div>
                    
                    <div class="customer-detail">
                        <h4>êµ¬ë§¤ ì´ë ¥ (ìµœê·¼ 10ê±´)</h4>
                        <div class="purchase-history">
                            ${customerOrders.length > 0 ? customerOrders.slice(0, 10).map(order => `
                                <p style="margin: 5px 0; padding: 5px; background: white; border-radius: 3px;">
                                    <strong>${order.orderId}</strong> - â‚©${order.totalAmount.toLocaleString()} 
                                    <small>(${new Date(order.orderDate).toLocaleDateString('ko-KR')})</small>
                                </p>
                            `).join('') : '<p>êµ¬ë§¤ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
                        </div>
                    </div>
                `;

                document.getElementById('customerDetailContent').innerHTML = detailContent;
                document.getElementById('customerDetailModal').style.display = 'block';
                this.currentCustomer = customer;
            }

            editCustomer(customerId) {
                const customers = this.dataManager.getData('customers') || [];
                const customer = customers.find(c => c.customerId === customerId);
                if (!customer) return;

                // í¼ì— ë°ì´í„° ì…ë ¥
                document.getElementById('customerName').value = customer.name;
                document.getElementById('customerPhone').value = customer.phone;
                document.getElementById('customerEmail').value = customer.email;
                document.getElementById('customerBirth').value = customer.birth || '';
                document.getElementById('customerGender').value = customer.gender || '';
                document.getElementById('customerGrade').value = customer.grade;
                document.getElementById('customerAddress').value = customer.address || '';
                document.getElementById('customerMemo').value = customer.memo || '';

                document.getElementById('modalTitle').textContent = 'ê³ ê° ì •ë³´ ìˆ˜ì •';
                document.getElementById('customerModal').style.display = 'block';
                this.currentCustomer = customer;
            }

            saveCustomer() {
                const customers = this.dataManager.getData('customers') || [];
                const customerData = {
                    name: document.getElementById('customerName').value,
                    phone: document.getElementById('customerPhone').value,
                    email: document.getElementById('customerEmail').value,
                    birth: document.getElementById('customerBirth').value,
                    gender: document.getElementById('customerGender').value,
                    grade: document.getElementById('customerGrade').value,
                    address: document.getElementById('customerAddress').value,
                    memo: document.getElementById('customerMemo').value,
                    updatedAt: new Date().toISOString()
                };

                if (this.currentCustomer) {
                    // ìˆ˜ì •
                    const index = customers.findIndex(c => c.customerId === this.currentCustomer.customerId);
                    if (index !== -1) {
                        customers[index] = { ...customers[index], ...customerData };
                        this.showNotification('ê³ ê° ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    }
                } else {
                    // ì‹ ê·œ ë“±ë¡
                    const newCustomer = {
                        ...customerData,
                        customerId: this.generateCustomerId(),
                        region: this.extractRegion(customerData.address),
                        joinDate: new Date().toISOString(),
                        totalPurchase: 0,
                        purchaseCount: 0,
                        lastPurchase: null,
                        isActive: true,
                        createdAt: new Date().toISOString()
                    };
                    customers.unshift(newCustomer);
                    this.showNotification('ì‹ ê·œ ê³ ê°ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                }

                this.dataManager.setData('customers', customers);
                this.updateStats();
                this.renderCustomers();
                this.closeCustomerModal();
            }

            generateCustomerId() {
                const customers = this.dataManager.getData('customers') || [];
                const maxId = customers.length > 0 ?
                    Math.max(...customers.map(c => parseInt(c.customerId.replace('CUST', '')))) : 0;
                return `CUST${String(maxId + 1).padStart(6, '0')}`;
            }

            extractRegion(address) {
                if (!address) return 'ê¸°íƒ€';
                if (address.includes('ì„œìš¸')) return 'ì„œìš¸';
                if (address.includes('ê²½ê¸°')) return 'ê²½ê¸°';
                if (address.includes('ì¸ì²œ')) return 'ì¸ì²œ';
                if (address.includes('ë¶€ì‚°')) return 'ë¶€ì‚°';
                return 'ê¸°íƒ€';
            }

            openCustomerModal() {
                document.getElementById('customerModal').style.display = 'block';
                document.getElementById('customerForm').reset();
                document.getElementById('modalTitle').textContent = 'ì‹ ê·œ ê³ ê° ë“±ë¡';
                this.currentCustomer = null;
            }

            closeCustomerModal() {
                document.getElementById('customerModal').style.display = 'none';
                this.currentCustomer = null;
            }

            closeDetailModal() {
                document.getElementById('customerDetailModal').style.display = 'none';
                this.currentCustomer = null;
            }

            refreshCustomers() {
                this.updateStats();
                this.renderCustomers();
                this.showNotification('ê³ ê° ëª©ë¡ì´ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            }

            exportCustomers() {
                const customers = this.dataManager.getData('customers') || [];
                const report = {
                    generatedAt: new Date().toISOString(),
                    summary: {
                        totalCustomers: customers.length,
                        vipCustomers: customers.filter(c => c.grade === 'VIP').length,
                        activeCustomers: customers.filter(c => c.isActive).length,
                        totalPurchaseValue: customers.reduce((sum, c) => sum + (c.totalPurchase || 0), 0)
                    },
                    customers: customers
                };
                
                this.downloadJson(report, 'ê³ ê°í˜„í™©ë³´ê³ ì„œ.json');
                this.showNotification('ê³ ê° ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }

            downloadJson(data, filename) {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            showNotification(message, type) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        }

        // ì „ì—­ í•¨ìˆ˜ë“¤
        function switchTab(tab) {
            customerSystem.switchTab(tab);
        }

        function openCustomerModal() {
            customerSystem.openCustomerModal();
        }

        function closeCustomerModal() {
            customerSystem.closeCustomerModal();
        }

        function closeDetailModal() {
            customerSystem.closeDetailModal();
        }

        function editCustomer() {
            if (customerSystem.currentCustomer) {
                customerSystem.closeDetailModal();
                customerSystem.editCustomer(customerSystem.currentCustomer.customerId);
            }
        }

        function refreshCustomers() {
            customerSystem.refreshCustomers();
        }

        function exportCustomers() {
            customerSystem.exportCustomers();
        }

        // ì „ì—­ ë³€ìˆ˜
        let customerSystem;

        // DOM ë¡œë“œ í›„ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            customerSystem = new CustomerManagementSystem();
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const customerModal = document.getElementById('customerModal');
            const detailModal = document.getElementById('customerDetailModal');
            if (event.target === customerModal) {
                closeCustomerModal();
            }
            if (event.target === detailModal) {
                closeDetailModal();
            }
        }
    </script>
</body>
</html>