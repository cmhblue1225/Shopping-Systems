<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</title>
  <style>
    body { font-family: 'ë§‘ì€ ê³ ë”•', Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .header { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 20px; border-radius: 10px 10px 0 0; }
    .header h1 { margin: 0; }
    .content { padding: 20px; }
    .btn-group { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
    .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
    .btn-primary { background: #007bff; color: white; }
    .btn-primary:hover { background: #0056b3; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #1e7e34; }
    .btn-warning { background: #ffc107; color: #212529; }
    .btn-warning:hover { background: #e0a800; }
    .search-container { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
    .search-input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; flex: 1; }
    .category-tree { border: 1px solid #ddd; border-radius: 5px; max-height: 600px; overflow-y: auto; }
    .tree-node { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; position: relative; }
    .tree-node:hover { background: #f8f9fa; }
    .tree-node.level-1 { font-weight: bold; background: #e3f2fd; }
    .tree-node.level-2 { margin-left: 20px; background: #f3e5f5; }
    .tree-node.level-3 { margin-left: 40px; background: #e8f5e8; }
    .tree-node.level-4 { margin-left: 60px; background: #fff3e0; }
    .tree-node.expanded > .tree-children { display: block; }
    .tree-node.collapsed > .tree-children { display: none; }
    .tree-children { display: none; }
    .expand-icon { display: inline-block; width: 16px; text-align: center; margin-right: 8px; }
    .stats { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .stats-item { display: inline-block; margin-right: 20px; }
    .stats-number { font-weight: bold; color: #007bff; font-size: 18px; }
    .loading { text-align: center; padding: 40px; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h1>
      <p>ê³„ì¸µí˜• ì¹´í…Œê³ ë¦¬ êµ¬ì¡° ê´€ë¦¬ ë° ì¡°íšŒ</p>
    </div>
    
    <div class="content">
      <div class="btn-group">
        <button class="btn btn-primary" onclick="triggerFileInput()">ğŸ“ Excel íŒŒì¼ ì—…ë¡œë“œ</button>
        <button class="btn btn-primary" onclick="loadCategories()">ğŸ”„ ê¸°ë³¸ ê²½ë¡œì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn btn-success" onclick="exportCategories()">ğŸ“¤ ì¹´í…Œê³ ë¦¬ ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn btn-warning" onclick="showStats()">ğŸ“Š í†µê³„ ë³´ê¸°</button>
        <a href="index.html" class="btn" style="background: #6c757d; color: white;">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
      </div>
      
      <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileUpload(event)">
      
      <div class="stats" id="statsContainer">
        <div class="stats-item">ì´ ì¹´í…Œê³ ë¦¬: <span class="stats-number" id="totalCount">0</span>ê°œ</div>
        <div class="stats-item">1ì°¨ ì¹´í…Œê³ ë¦¬: <span class="stats-number" id="level1Count">0</span>ê°œ</div>
        <div class="stats-item">2ì°¨ ì¹´í…Œê³ ë¦¬: <span class="stats-number" id="level2Count">0</span>ê°œ</div>
        <div class="stats-item">3ì°¨ ì¹´í…Œê³ ë¦¬: <span class="stats-number" id="level3Count">0</span>ê°œ</div>
        <div class="stats-item">4ì°¨ ì¹´í…Œê³ ë¦¬: <span class="stats-number" id="level4Count">0</span>ê°œ</div>
      </div>
      
      <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰..." onkeyup="searchCategories()">
        <button class="btn btn-primary" onclick="searchCategories()">ğŸ” ê²€ìƒ‰</button>
        <button class="btn" onclick="clearSearch()">âœ–ï¸ ì´ˆê¸°í™”</button>
      </div>
      
      <div id="categoryContainer">
        <div class="loading">ì¹´í…Œê³ ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ 'ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <script>
    let categories = [];
    let categoryTree = {};

    document.addEventListener('DOMContentLoaded', function() {
      const savedCategories = localStorage.getItem('categories');
      if (savedCategories) {
        categories = JSON.parse(savedCategories);
        buildCategoryTree();
        displayCategories();
        updateStats();
      }
    });

    function triggerFileInput() {
      document.getElementById('excelFileInput').click();
    }

    async function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.name.match(/\.(xlsx|xls)$/)) {
        alert('Excel íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }

      try {
        document.getElementById('categoryContainer').innerHTML = '<div class="loading">Excel íŒŒì¼ì„ ë¶„ì„ì¤‘...</div>';
        
        const arrayBuffer = await file.arrayBuffer();
        await processCategoryData(arrayBuffer);
        
        // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
        event.target.value = '';
      } catch (error) {
        console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        document.getElementById('categoryContainer').innerHTML = '<div class="loading">íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }

    async function loadCategories() {
      try {
        document.getElementById('categoryContainer').innerHTML = '<div class="loading">ì¹´í…Œê³ ë¦¬ ë°ì´í„°ë¥¼ ë¡œë”©ì¤‘...</div>';
        
        const response = await fetch('../ì¹´í…Œê³ ë¦¬.xlsx');
        if (!response.ok) {
          throw new Error('ì¹´í…Œê³ ë¦¬.xlsx íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ì—…ë¡œë“œë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
        }
        
        const arrayBuffer = await response.arrayBuffer();
        await processCategoryData(arrayBuffer);
      } catch (error) {
        console.error('ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ê¸°ë³¸ ê²½ë¡œì—ì„œ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. "Excel íŒŒì¼ ì—…ë¡œë“œ" ë²„íŠ¼ì„ ì‚¬ìš©í•´ì„œ ì¹´í…Œê³ ë¦¬.xlsx íŒŒì¼ì„ ì§ì ‘ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
        document.getElementById('categoryContainer').innerHTML = '<div class="loading">ì¹´í…Œê³ ë¦¬ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ ì—…ë¡œë“œë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</div>';
      }
    }

    async function processCategoryData(arrayBuffer) {
      const workbook = new ExcelJS.Workbook();
      await workbook.xlsx.load(arrayBuffer);
      
      const worksheet = workbook.getWorksheet(1);
      categories = [];
      
      worksheet.eachRow((row, rowNumber) => {
        if (rowNumber > 1) {
          const rowData = row.values;
          if (rowData[2]) { // 1ì°¨ ì¹´í…Œê³ ë¦¬ê°€ ìˆëŠ” ê²½ìš°ë§Œ
            categories.push({
              groupId: rowData[1] || rowNumber - 1,
              category1st: rowData[2] || '',
              category2nd: rowData[3] || '',
              category3rd: rowData[4] || '',
              category4th: rowData[5] || ''
            });
          }
        }
      });
      
      localStorage.setItem('categories', JSON.stringify(categories));
      buildCategoryTree();
      displayCategories();
      updateStats();
      
      alert(`ì¹´í…Œê³ ë¦¬ ${categories.length}ê°œë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
    }

    function buildCategoryTree() {
      categoryTree = {};
      
      categories.forEach(cat => {
        if (!categoryTree[cat.category1st]) {
          categoryTree[cat.category1st] = {};
        }
        
        if (cat.category2nd) {
          if (!categoryTree[cat.category1st][cat.category2nd]) {
            categoryTree[cat.category1st][cat.category2nd] = {};
          }
          
          if (cat.category3rd) {
            if (!categoryTree[cat.category1st][cat.category2nd][cat.category3rd]) {
              categoryTree[cat.category1st][cat.category2nd][cat.category3rd] = {};
            }
            
            if (cat.category4th) {
              categoryTree[cat.category1st][cat.category2nd][cat.category3rd][cat.category4th] = true;
            }
          }
        }
      });
    }

    function displayCategories() {
      const container = document.getElementById('categoryContainer');
      if (Object.keys(categoryTree).length === 0) {
        container.innerHTML = '<div class="loading">í‘œì‹œí•  ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      let html = '<div class="category-tree">';
      
      Object.keys(categoryTree).forEach(level1 => {
        const level1Id = 'cat1_' + level1.replace(/\s+/g, '_');
        const hasChildren = Object.keys(categoryTree[level1]).length > 0;
        
        html += `
          <div class="tree-node level-1 ${hasChildren ? 'collapsed' : ''}" onclick="toggleNode('${level1Id}')">
            <span class="expand-icon">${hasChildren ? 'â–¶' : 'â—'}</span>
            <strong>${level1}</strong>
          </div>
        `;
        
        if (hasChildren) {
          html += `<div class="tree-children" id="${level1Id}">`;
          
          Object.keys(categoryTree[level1]).forEach(level2 => {
            const level2Id = 'cat2_' + level1.replace(/\s+/g, '_') + '_' + level2.replace(/\s+/g, '_');
            const hasChildren2 = Object.keys(categoryTree[level1][level2]).length > 0;
            
            html += `
              <div class="tree-node level-2 ${hasChildren2 ? 'collapsed' : ''}" onclick="toggleNode('${level2Id}')">
                <span class="expand-icon">${hasChildren2 ? 'â–¶' : 'â—'}</span>
                ${level2}
              </div>
            `;
            
            if (hasChildren2) {
              html += `<div class="tree-children" id="${level2Id}">`;
              
              Object.keys(categoryTree[level1][level2]).forEach(level3 => {
                const level3Id = 'cat3_' + level1.replace(/\s+/g, '_') + '_' + level2.replace(/\s+/g, '_') + '_' + level3.replace(/\s+/g, '_');
                const hasChildren3 = Object.keys(categoryTree[level1][level2][level3]).length > 0;
                
                html += `
                  <div class="tree-node level-3 ${hasChildren3 ? 'collapsed' : ''}" onclick="toggleNode('${level3Id}')">
                    <span class="expand-icon">${hasChildren3 ? 'â–¶' : 'â—'}</span>
                    ${level3}
                  </div>
                `;
                
                if (hasChildren3) {
                  html += `<div class="tree-children" id="${level3Id}">`;
                  
                  Object.keys(categoryTree[level1][level2][level3]).forEach(level4 => {
                    html += `
                      <div class="tree-node level-4">
                        <span class="expand-icon">â—</span>
                        ${level4}
                      </div>
                    `;
                  });
                  
                  html += '</div>';
                }
              });
              
              html += '</div>';
            }
          });
          
          html += '</div>';
        }
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    function toggleNode(nodeId) {
      event.stopPropagation();
      const node = document.getElementById(nodeId);
      const parentNode = node.previousElementSibling;
      
      if (node.style.display === 'none' || !node.style.display) {
        node.style.display = 'block';
        parentNode.classList.remove('collapsed');
        parentNode.classList.add('expanded');
        parentNode.querySelector('.expand-icon').textContent = 'â–¼';
      } else {
        node.style.display = 'none';
        parentNode.classList.remove('expanded');
        parentNode.classList.add('collapsed');
        parentNode.querySelector('.expand-icon').textContent = 'â–¶';
      }
    }

    function updateStats() {
      const level1Set = new Set();
      const level2Set = new Set();
      const level3Set = new Set();
      const level4Set = new Set();
      
      categories.forEach(cat => {
        if (cat.category1st) level1Set.add(cat.category1st);
        if (cat.category2nd) level2Set.add(cat.category1st + '>' + cat.category2nd);
        if (cat.category3rd) level3Set.add(cat.category1st + '>' + cat.category2nd + '>' + cat.category3rd);
        if (cat.category4th) level4Set.add(cat.category1st + '>' + cat.category2nd + '>' + cat.category3rd + '>' + cat.category4th);
      });
      
      document.getElementById('totalCount').textContent = categories.length;
      document.getElementById('level1Count').textContent = level1Set.size;
      document.getElementById('level2Count').textContent = level2Set.size;
      document.getElementById('level3Count').textContent = level3Set.size;
      document.getElementById('level4Count').textContent = level4Set.size;
    }

    function searchCategories() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      if (!searchTerm) {
        displayCategories();
        return;
      }
      
      const filteredCategories = categories.filter(cat => 
        cat.category1st.toLowerCase().includes(searchTerm) ||
        cat.category2nd.toLowerCase().includes(searchTerm) ||
        cat.category3rd.toLowerCase().includes(searchTerm) ||
        cat.category4th.toLowerCase().includes(searchTerm)
      );
      
      const container = document.getElementById('categoryContainer');
      if (filteredCategories.length === 0) {
        container.innerHTML = '<div class="loading">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      let html = '<div class="category-tree">';
      filteredCategories.forEach(cat => {
        html += `
          <div class="tree-node level-1">
            <span class="expand-icon">ğŸ”</span>
            <strong>${cat.category1st}</strong>
            ${cat.category2nd ? ' > ' + cat.category2nd : ''}
            ${cat.category3rd ? ' > ' + cat.category3rd : ''}
            ${cat.category4th ? ' > ' + cat.category4th : ''}
          </div>
        `;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    function clearSearch() {
      document.getElementById('searchInput').value = '';
      displayCategories();
    }

    function exportCategories() {
      if (categories.length === 0) {
        alert('ë‚´ë³´ë‚¼ ì¹´í…Œê³ ë¦¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const dataStr = JSON.stringify(categories, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'categories_' + new Date().toISOString().split('T')[0] + '.json';
      link.click();
      URL.revokeObjectURL(url);
    }

    function showStats() {
      updateStats();
      alert(`ì¹´í…Œê³ ë¦¬ í†µê³„:
      
ì´ ì¹´í…Œê³ ë¦¬: ${categories.length}ê°œ
1ì°¨ ì¹´í…Œê³ ë¦¬: ${document.getElementById('level1Count').textContent}ê°œ
2ì°¨ ì¹´í…Œê³ ë¦¬: ${document.getElementById('level2Count').textContent}ê°œ  
3ì°¨ ì¹´í…Œê³ ë¦¬: ${document.getElementById('level3Count').textContent}ê°œ
4ì°¨ ì¹´í…Œê³ ë¦¬: ${document.getElementById('level4Count').textContent}ê°œ`);
    }
  </script>
</body>
</html>