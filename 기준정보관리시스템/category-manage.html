<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</title>
  <style>
    body { font-family: 'ë§‘ì€ ê³ ë”•', Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .header { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 20px; border-radius: 10px 10px 0 0; }
    .header h1 { margin: 0; }
    .content { padding: 20px; }
    .btn-group { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
    .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
    .btn-primary { background: #007bff; color: white; }
    .btn-primary:hover { background: #0056b3; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #1e7e34; }
    .btn-warning { background: #ffc107; color: #212529; }
    .btn-warning:hover { background: #e0a800; }
    .search-container { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
    .search-input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; flex: 1; }
    .category-tree { border: 1px solid #ddd; border-radius: 5px; max-height: 600px; overflow-y: auto; }
    .tree-node { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; position: relative; }
    .tree-node:hover { background: #f8f9fa; }
    .tree-node.level-1 { font-weight: bold; background: #e3f2fd; }
    .tree-node.level-2 { margin-left: 20px; background: #f3e5f5; }
    .tree-node.level-3 { margin-left: 40px; background: #e8f5e8; }
    .tree-node.level-4 { margin-left: 60px; background: #fff3e0; }
    .tree-node.expanded > .tree-children { display: block; }
    .tree-node.collapsed > .tree-children { display: none; }
    .tree-children { display: none; }
    .expand-icon { display: inline-block; width: 16px; text-align: center; margin-right: 8px; }
    .stats { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .stats-item { display: inline-block; margin-right: 20px; }
    .stats-number { font-weight: bold; color: #007bff; font-size: 18px; }
    .loading { text-align: center; padding: 40px; color: #666; }
    
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; margin: 10% auto; padding: 0; width: 500px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: modalShow 0.3s ease; }
    @keyframes modalShow { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
    .modal-header { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 20px; border-radius: 10px 10px 0 0; position: relative; }
    .modal-header h3 { margin: 0; }
    .modal-close { position: absolute; right: 15px; top: 15px; color: white; font-size: 24px; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.3s; }
    .modal-close:hover { background: rgba(255,255,255,0.2); }
    .modal-body { padding: 20px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
    .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
    .form-control:focus { border-color: #4CAF50; outline: none; box-shadow: 0 0 5px rgba(76, 175, 80, 0.3); }
    .modal-footer { padding: 15px 20px; text-align: right; border-top: 1px solid #eee; }
    .btn-modal { padding: 8px 20px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px; font-size: 14px; }
    .btn-modal-primary { background: #4CAF50; color: white; }
    .btn-modal-primary:hover { background: #45a049; }
    .btn-modal-secondary { background: #6c757d; color: white; }
    .btn-modal-secondary:hover { background: #5a6268; }
    .btn-modal-danger { background: #dc3545; color: white; }
    .btn-modal-danger:hover { background: #c82333; }
    
    /* íŠ¸ë¦¬ ë…¸ë“œ ì•¡ì…˜ ë²„íŠ¼ */
    .tree-node-actions { display: none; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); }
    .tree-node:hover .tree-node-actions { display: block; }
    .action-btn { background: #007bff; color: white; border: none; padding: 4px 8px; margin: 0 2px; border-radius: 3px; cursor: pointer; font-size: 11px; }
    .action-btn:hover { background: #0056b3; }
    .action-btn.edit { background: #ffc107; }
    .action-btn.edit:hover { background: #e0a800; }
    .action-btn.delete { background: #dc3545; }
    .action-btn.delete:hover { background: #c82333; }
    
    /* í•„ìˆ˜ ì…ë ¥ í‘œì‹œ */
    .required { color: #dc3545; }
    .form-help { font-size: 12px; color: #666; margin-top: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h1>
      <p>ê³„ì¸µí˜• ì¹´í…Œê³ ë¦¬ êµ¬ì¡° ê´€ë¦¬ ë° ì¡°íšŒ</p>
    </div>
    
    <div class="content">
      <div class="btn-group">
        <button class="btn btn-primary" onclick="triggerFileInput()">ğŸ“ Excel íŒŒì¼ ì—…ë¡œë“œ</button>
        <button class="btn btn-primary" onclick="loadCategories()">ğŸ”„ ê¸°ë³¸ ê²½ë¡œì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn btn-success" onclick="showAddCategoryModal()">â• ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
        <button class="btn btn-success" onclick="exportCategories()">ğŸ“¤ ì¹´í…Œê³ ë¦¬ ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn btn-warning" onclick="showStats()">ğŸ“Š í†µê³„ ë³´ê¸°</button>
        <a href="index.html" class="btn" style="background: #6c757d; color: white;">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
      </div>
      
      <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileUpload(event)">
      
      <div class="stats" id="statsContainer">
        <div class="stats-item">ì´ ì¹´í…Œê³ ë¦¬: <span class="stats-number" id="totalCount">0</span>ê°œ</div>
        <div class="stats-item">1ì°¨ ì¹´í…Œê³ ë¦¬: <span class="stats-number" id="level1Count">0</span>ê°œ</div>
        <div class="stats-item">2ì°¨ ì¹´í…Œê³ ë¦¬: <span class="stats-number" id="level2Count">0</span>ê°œ</div>
        <div class="stats-item">3ì°¨ ì¹´í…Œê³ ë¦¬: <span class="stats-number" id="level3Count">0</span>ê°œ</div>
        <div class="stats-item">4ì°¨ ì¹´í…Œê³ ë¦¬: <span class="stats-number" id="level4Count">0</span>ê°œ</div>
      </div>
      
      <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰..." onkeyup="searchCategories()">
        <button class="btn btn-primary" onclick="searchCategories()">ğŸ” ê²€ìƒ‰</button>
        <button class="btn" onclick="clearSearch()">âœ–ï¸ ì´ˆê¸°í™”</button>
      </div>
      
      <div id="categoryContainer">
        <div class="loading">ì¹´í…Œê³ ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ 'ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>
      </div>
    </div>
  </div>

  <!-- ì¹´í…Œê³ ë¦¬ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="categoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">ì¹´í…Œê³ ë¦¬ ì¶”ê°€</h3>
        <span class="modal-close" onclick="closeCategoryModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="categoryForm">
          <div class="form-group">
            <label for="groupId">Group ID</label>
            <input type="number" id="groupId" class="form-control" placeholder="ìë™ ìƒì„±ë©ë‹ˆë‹¤" readonly>
            <div class="form-help">Group IDëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.</div>
          </div>
          
          <div class="form-group">
            <label for="category1st">1ì°¨ ì¹´í…Œê³ ë¦¬ <span class="required">*</span></label>
            <input type="text" id="category1st" class="form-control" placeholder="ì˜ˆ: ìƒí™œí”ŒëŸ¬ìŠ¤" required>
          </div>
          
          <div class="form-group">
            <label for="category2nd">2ì°¨ ì¹´í…Œê³ ë¦¬</label>
            <input type="text" id="category2nd" class="form-control" placeholder="ì˜ˆ: í™ˆ&ì¹´ì„œë¹„ìŠ¤">
          </div>
          
          <div class="form-group">
            <label for="category3rd">3ì°¨ ì¹´í…Œê³ ë¦¬</label>
            <input type="text" id="category3rd" class="form-control" placeholder="ì˜ˆ: ì„¸íƒ/ì²­ì†Œ">
          </div>
          
          <div class="form-group">
            <label for="category4th">4ì°¨ ì¹´í…Œê³ ë¦¬</label>
            <input type="text" id="category4th" class="form-control" placeholder="ì˜ˆ: ì„¸íƒìˆ˜ê±°">
            <div class="form-help">4ì°¨ ì¹´í…Œê³ ë¦¬ê¹Œì§€ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal btn-modal-secondary" onclick="closeCategoryModal()">ì·¨ì†Œ</button>
        <button type="button" class="btn-modal btn-modal-primary" onclick="saveCategory()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì¹´í…Œê³ ë¦¬ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
  <div id="deleteModal" class="modal">
    <div class="modal-content" style="width: 400px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #dc3545, #c82333);">
        <h3>ì¹´í…Œê³ ë¦¬ ì‚­ì œ</h3>
        <span class="modal-close" onclick="closeDeleteModal()">&times;</span>
      </div>
      <div class="modal-body">
        <p><strong>ì •ë§ë¡œ ì´ ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</strong></p>
        <div id="deleteInfo" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">
        </div>
        <p style="color: #dc3545; font-size: 14px;">âš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal btn-modal-secondary" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
        <button type="button" class="btn-modal btn-modal-danger" onclick="confirmDelete()">ì‚­ì œ</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <script>
    let categories = [];
    let categoryTree = {};

    document.addEventListener('DOMContentLoaded', function() {
      const savedCategories = localStorage.getItem('categories');
      if (savedCategories) {
        categories = JSON.parse(savedCategories);
        buildCategoryTree();
        displayCategories();
        updateStats();
      }
    });

    function triggerFileInput() {
      document.getElementById('excelFileInput').click();
    }

    async function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.name.match(/\.(xlsx|xls)$/)) {
        alert('Excel íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }

      try {
        document.getElementById('categoryContainer').innerHTML = '<div class="loading">Excel íŒŒì¼ì„ ë¶„ì„ì¤‘...</div>';
        
        const arrayBuffer = await file.arrayBuffer();
        await processCategoryData(arrayBuffer);
        
        // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
        event.target.value = '';
      } catch (error) {
        console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        document.getElementById('categoryContainer').innerHTML = '<div class="loading">íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }

    async function loadCategories() {
      try {
        document.getElementById('categoryContainer').innerHTML = '<div class="loading">ì¹´í…Œê³ ë¦¬ ë°ì´í„°ë¥¼ ë¡œë”©ì¤‘...</div>';
        
        const response = await fetch('../ì¹´í…Œê³ ë¦¬.xlsx');
        if (!response.ok) {
          throw new Error('ì¹´í…Œê³ ë¦¬.xlsx íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ì—…ë¡œë“œë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
        }
        
        const arrayBuffer = await response.arrayBuffer();
        await processCategoryData(arrayBuffer);
      } catch (error) {
        console.error('ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ê¸°ë³¸ ê²½ë¡œì—ì„œ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. "Excel íŒŒì¼ ì—…ë¡œë“œ" ë²„íŠ¼ì„ ì‚¬ìš©í•´ì„œ ì¹´í…Œê³ ë¦¬.xlsx íŒŒì¼ì„ ì§ì ‘ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
        document.getElementById('categoryContainer').innerHTML = '<div class="loading">ì¹´í…Œê³ ë¦¬ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ ì—…ë¡œë“œë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</div>';
      }
    }

    async function processCategoryData(arrayBuffer) {
      const workbook = new ExcelJS.Workbook();
      await workbook.xlsx.load(arrayBuffer);
      
      const worksheet = workbook.getWorksheet(1);
      categories = [];
      
      worksheet.eachRow((row, rowNumber) => {
        if (rowNumber > 1) {
          const rowData = row.values;
          if (rowData[2]) { // 1ì°¨ ì¹´í…Œê³ ë¦¬ê°€ ìˆëŠ” ê²½ìš°ë§Œ
            categories.push({
              groupId: rowData[1] || rowNumber - 1,
              category1st: rowData[2] || '',
              category2nd: rowData[3] || '',
              category3rd: rowData[4] || '',
              category4th: rowData[5] || ''
            });
          }
        }
      });
      
      localStorage.setItem('categories', JSON.stringify(categories));
      buildCategoryTree();
      displayCategories();
      updateStats();
      
      alert(`ì¹´í…Œê³ ë¦¬ ${categories.length}ê°œë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
    }

    function buildCategoryTree() {
      categoryTree = {};
      
      categories.forEach(cat => {
        if (!categoryTree[cat.category1st]) {
          categoryTree[cat.category1st] = {};
        }
        
        if (cat.category2nd) {
          if (!categoryTree[cat.category1st][cat.category2nd]) {
            categoryTree[cat.category1st][cat.category2nd] = {};
          }
          
          if (cat.category3rd) {
            if (!categoryTree[cat.category1st][cat.category2nd][cat.category3rd]) {
              categoryTree[cat.category1st][cat.category2nd][cat.category3rd] = {};
            }
            
            if (cat.category4th) {
              categoryTree[cat.category1st][cat.category2nd][cat.category3rd][cat.category4th] = true;
            }
          }
        }
      });
    }

    function displayCategories() {
      const container = document.getElementById('categoryContainer');
      if (Object.keys(categoryTree).length === 0) {
        container.innerHTML = '<div class="loading">í‘œì‹œí•  ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      let html = '<div class="category-tree">';
      
      Object.keys(categoryTree).forEach(level1 => {
        const level1Id = 'cat1_' + level1.replace(/\s+/g, '_');
        const hasChildren = Object.keys(categoryTree[level1]).length > 0;
        
        const level1Category = categories.find(cat => cat.category1st === level1 && !cat.category2nd);
        const categoryId = level1Category ? level1Category.groupId : 'temp_' + Date.now();
        
        html += `
          <div class="tree-node level-1 ${hasChildren ? 'collapsed' : ''}" onclick="toggleNode('${level1Id}')">
            <span class="expand-icon">${hasChildren ? 'â–¶' : 'â—'}</span>
            <strong>${level1}</strong>
            <div class="tree-node-actions">
              <button class="action-btn edit" onclick="event.stopPropagation(); editCategory('${categoryId}', '${level1}', '', '', '')" title="ìˆ˜ì •">âœï¸</button>
              <button class="action-btn delete" onclick="event.stopPropagation(); deleteCategory('${categoryId}', '${level1}', '', '', '')" title="ì‚­ì œ">ğŸ—‘ï¸</button>
            </div>
          </div>
        `;
        
        if (hasChildren) {
          html += `<div class="tree-children" id="${level1Id}">`;
          
          Object.keys(categoryTree[level1]).forEach(level2 => {
            const level2Id = 'cat2_' + level1.replace(/\s+/g, '_') + '_' + level2.replace(/\s+/g, '_');
            const hasChildren2 = Object.keys(categoryTree[level1][level2]).length > 0;
            
            const level2Category = categories.find(cat => cat.category1st === level1 && cat.category2nd === level2 && !cat.category3rd);
            const categoryId2 = level2Category ? level2Category.groupId : 'temp_' + Date.now();
            
            html += `
              <div class="tree-node level-2 ${hasChildren2 ? 'collapsed' : ''}" onclick="toggleNode('${level2Id}')">
                <span class="expand-icon">${hasChildren2 ? 'â–¶' : 'â—'}</span>
                ${level2}
                <div class="tree-node-actions">
                  <button class="action-btn edit" onclick="event.stopPropagation(); editCategory('${categoryId2}', '${level1}', '${level2}', '', '')" title="ìˆ˜ì •">âœï¸</button>
                  <button class="action-btn delete" onclick="event.stopPropagation(); deleteCategory('${categoryId2}', '${level1}', '${level2}', '', '')" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                </div>
              </div>
            `;
            
            if (hasChildren2) {
              html += `<div class="tree-children" id="${level2Id}">`;
              
              Object.keys(categoryTree[level1][level2]).forEach(level3 => {
                const level3Id = 'cat3_' + level1.replace(/\s+/g, '_') + '_' + level2.replace(/\s+/g, '_') + '_' + level3.replace(/\s+/g, '_');
                const hasChildren3 = Object.keys(categoryTree[level1][level2][level3]).length > 0;
                
                const level3Category = categories.find(cat => cat.category1st === level1 && cat.category2nd === level2 && cat.category3rd === level3 && !cat.category4th);
                const categoryId3 = level3Category ? level3Category.groupId : 'temp_' + Date.now();
                
                html += `
                  <div class="tree-node level-3 ${hasChildren3 ? 'collapsed' : ''}" onclick="toggleNode('${level3Id}')">
                    <span class="expand-icon">${hasChildren3 ? 'â–¶' : 'â—'}</span>
                    ${level3}
                    <div class="tree-node-actions">
                      <button class="action-btn edit" onclick="event.stopPropagation(); editCategory('${categoryId3}', '${level1}', '${level2}', '${level3}', '')" title="ìˆ˜ì •">âœï¸</button>
                      <button class="action-btn delete" onclick="event.stopPropagation(); deleteCategory('${categoryId3}', '${level1}', '${level2}', '${level3}', '')" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                    </div>
                  </div>
                `;
                
                if (hasChildren3) {
                  html += `<div class="tree-children" id="${level3Id}">`;
                  
                  Object.keys(categoryTree[level1][level2][level3]).forEach(level4 => {
                    const level4Category = categories.find(cat => cat.category1st === level1 && cat.category2nd === level2 && cat.category3rd === level3 && cat.category4th === level4);
                    const categoryId4 = level4Category ? level4Category.groupId : 'temp_' + Date.now();
                    
                    html += `
                      <div class="tree-node level-4">
                        <span class="expand-icon">â—</span>
                        ${level4}
                        <div class="tree-node-actions">
                          <button class="action-btn edit" onclick="event.stopPropagation(); editCategory('${categoryId4}', '${level1}', '${level2}', '${level3}', '${level4}')" title="ìˆ˜ì •">âœï¸</button>
                          <button class="action-btn delete" onclick="event.stopPropagation(); deleteCategory('${categoryId4}', '${level1}', '${level2}', '${level3}', '${level4}')" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                        </div>
                      </div>
                    `;
                  });
                  
                  html += '</div>';
                }
              });
              
              html += '</div>';
            }
          });
          
          html += '</div>';
        }
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    function toggleNode(nodeId) {
      event.stopPropagation();
      const node = document.getElementById(nodeId);
      const parentNode = node.previousElementSibling;
      
      if (node.style.display === 'none' || !node.style.display) {
        node.style.display = 'block';
        parentNode.classList.remove('collapsed');
        parentNode.classList.add('expanded');
        parentNode.querySelector('.expand-icon').textContent = 'â–¼';
      } else {
        node.style.display = 'none';
        parentNode.classList.remove('expanded');
        parentNode.classList.add('collapsed');
        parentNode.querySelector('.expand-icon').textContent = 'â–¶';
      }
    }

    function updateStats() {
      const level1Set = new Set();
      const level2Set = new Set();
      const level3Set = new Set();
      const level4Set = new Set();
      
      categories.forEach(cat => {
        if (cat.category1st) level1Set.add(cat.category1st);
        if (cat.category2nd) level2Set.add(cat.category1st + '>' + cat.category2nd);
        if (cat.category3rd) level3Set.add(cat.category1st + '>' + cat.category2nd + '>' + cat.category3rd);
        if (cat.category4th) level4Set.add(cat.category1st + '>' + cat.category2nd + '>' + cat.category3rd + '>' + cat.category4th);
      });
      
      document.getElementById('totalCount').textContent = categories.length;
      document.getElementById('level1Count').textContent = level1Set.size;
      document.getElementById('level2Count').textContent = level2Set.size;
      document.getElementById('level3Count').textContent = level3Set.size;
      document.getElementById('level4Count').textContent = level4Set.size;
    }

    function searchCategories() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      if (!searchTerm) {
        displayCategories();
        return;
      }
      
      const filteredCategories = categories.filter(cat => 
        cat.category1st.toLowerCase().includes(searchTerm) ||
        cat.category2nd.toLowerCase().includes(searchTerm) ||
        cat.category3rd.toLowerCase().includes(searchTerm) ||
        cat.category4th.toLowerCase().includes(searchTerm)
      );
      
      const container = document.getElementById('categoryContainer');
      if (filteredCategories.length === 0) {
        container.innerHTML = '<div class="loading">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      let html = '<div class="category-tree">';
      filteredCategories.forEach(cat => {
        html += `
          <div class="tree-node level-1">
            <span class="expand-icon">ğŸ”</span>
            <strong>${cat.category1st}</strong>
            ${cat.category2nd ? ' > ' + cat.category2nd : ''}
            ${cat.category3rd ? ' > ' + cat.category3rd : ''}
            ${cat.category4th ? ' > ' + cat.category4th : ''}
          </div>
        `;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    function clearSearch() {
      document.getElementById('searchInput').value = '';
      displayCategories();
    }

    function exportCategories() {
      if (categories.length === 0) {
        alert('ë‚´ë³´ë‚¼ ì¹´í…Œê³ ë¦¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const dataStr = JSON.stringify(categories, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'categories_' + new Date().toISOString().split('T')[0] + '.json';
      link.click();
      URL.revokeObjectURL(url);
    }

    function showStats() {
      updateStats();
      alert(`ì¹´í…Œê³ ë¦¬ í†µê³„:
      
ì´ ì¹´í…Œê³ ë¦¬: ${categories.length}ê°œ
1ì°¨ ì¹´í…Œê³ ë¦¬: ${document.getElementById('level1Count').textContent}ê°œ
2ì°¨ ì¹´í…Œê³ ë¦¬: ${document.getElementById('level2Count').textContent}ê°œ  
3ì°¨ ì¹´í…Œê³ ë¦¬: ${document.getElementById('level3Count').textContent}ê°œ
4ì°¨ ì¹´í…Œê³ ë¦¬: ${document.getElementById('level4Count').textContent}ê°œ`);
    }

    // ì¹´í…Œê³ ë¦¬ CRUD ê¸°ëŠ¥
    let currentEditingId = null;

    function showAddCategoryModal() {
      currentEditingId = null;
      document.getElementById('modalTitle').textContent = 'ì¹´í…Œê³ ë¦¬ ì¶”ê°€';
      document.getElementById('groupId').value = '';
      document.getElementById('category1st').value = '';
      document.getElementById('category2nd').value = '';
      document.getElementById('category3rd').value = '';
      document.getElementById('category4th').value = '';
      document.getElementById('categoryModal').style.display = 'block';
    }

    function editCategory(categoryId, cat1, cat2, cat3, cat4) {
      currentEditingId = categoryId;
      document.getElementById('modalTitle').textContent = 'ì¹´í…Œê³ ë¦¬ ìˆ˜ì •';
      document.getElementById('groupId').value = categoryId;
      document.getElementById('category1st').value = cat1 || '';
      document.getElementById('category2nd').value = cat2 || '';
      document.getElementById('category3rd').value = cat3 || '';
      document.getElementById('category4th').value = cat4 || '';
      document.getElementById('categoryModal').style.display = 'block';
    }

    function deleteCategory(categoryId, cat1, cat2, cat3, cat4) {
      let categoryPath = cat1;
      if (cat2) categoryPath += ' > ' + cat2;
      if (cat3) categoryPath += ' > ' + cat3;
      if (cat4) categoryPath += ' > ' + cat4;
      
      document.getElementById('deleteInfo').innerHTML = `
        <strong>ì¹´í…Œê³ ë¦¬:</strong> ${categoryPath}<br>
        <strong>Group ID:</strong> ${categoryId}
      `;
      
      // ì‚­ì œí•  ì¹´í…Œê³ ë¦¬ ID ì €ì¥
      document.getElementById('deleteModal').setAttribute('data-delete-id', categoryId);
      document.getElementById('deleteModal').setAttribute('data-delete-path', categoryPath);
      document.getElementById('deleteModal').style.display = 'block';
    }

    function closeCategoryModal() {
      document.getElementById('categoryModal').style.display = 'none';
      currentEditingId = null;
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
    }

    function saveCategory() {
      const cat1 = document.getElementById('category1st').value.trim();
      const cat2 = document.getElementById('category2nd').value.trim();
      const cat3 = document.getElementById('category3rd').value.trim();
      const cat4 = document.getElementById('category4th').value.trim();
      
      if (!cat1) {
        alert('1ì°¨ ì¹´í…Œê³ ë¦¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
      }
      
      // ì¤‘ë³µ í™•ì¸
      const isDuplicate = categories.some(cat => 
        cat.category1st === cat1 && 
        cat.category2nd === cat2 && 
        cat.category3rd === cat3 && 
        cat.category4th === cat4 &&
        (currentEditingId === null || cat.groupId !== currentEditingId)
      );
      
      if (isDuplicate) {
        alert('ë™ì¼í•œ ì¹´í…Œê³ ë¦¬ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.');
        return;
      }
      
      if (currentEditingId) {
        // ìˆ˜ì •
        const categoryIndex = categories.findIndex(cat => cat.groupId == currentEditingId);
        if (categoryIndex !== -1) {
          categories[categoryIndex] = {
            groupId: currentEditingId,
            category1st: cat1,
            category2nd: cat2,
            category3rd: cat3,
            category4th: cat4
          };
        }
      } else {
        // ì¶”ê°€
        const newGroupId = Math.max(...categories.map(cat => parseInt(cat.groupId) || 0)) + 1;
        categories.push({
          groupId: newGroupId,
          category1st: cat1,
          category2nd: cat2,
          category3rd: cat3,
          category4th: cat4
        });
      }
      
      localStorage.setItem('categories', JSON.stringify(categories));
      buildCategoryTree();
      displayCategories();
      updateStats();
      closeCategoryModal();
      
      alert(currentEditingId ? 'ì¹´í…Œê³ ë¦¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì¹´í…Œê³ ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function confirmDelete() {
      const deleteId = document.getElementById('deleteModal').getAttribute('data-delete-id');
      const deletePath = document.getElementById('deleteModal').getAttribute('data-delete-path');
      
      // í•˜ìœ„ ì¹´í…Œê³ ë¦¬ í™•ì¸
      const categoryToDelete = categories.find(cat => cat.groupId == deleteId);
      if (categoryToDelete) {
        const hasSubCategories = categories.some(cat => {
          // ì‚­ì œí•˜ë ¤ëŠ” ì¹´í…Œê³ ë¦¬ë³´ë‹¤ ë” ê¹Šì€ ë ˆë²¨ì˜ ì¹´í…Œê³ ë¦¬ê°€ ìˆëŠ”ì§€ í™•ì¸
          if (categoryToDelete.category4th) return false; // 4ì°¨ëŠ” í•˜ìœ„ ì—†ìŒ
          if (categoryToDelete.category3rd) {
            return cat.category1st === categoryToDelete.category1st &&
                   cat.category2nd === categoryToDelete.category2nd &&
                   cat.category3rd === categoryToDelete.category3rd &&
                   cat.category4th && cat.groupId != deleteId;
          }
          if (categoryToDelete.category2nd) {
            return cat.category1st === categoryToDelete.category1st &&
                   cat.category2nd === categoryToDelete.category2nd &&
                   cat.category3rd && cat.groupId != deleteId;
          }
          // 1ì°¨ ì¹´í…Œê³ ë¦¬ì¸ ê²½ìš°
          return cat.category1st === categoryToDelete.category1st &&
                 cat.category2nd && cat.groupId != deleteId;
        });
        
        if (hasSubCategories) {
          alert('í•˜ìœ„ ì¹´í…Œê³ ë¦¬ê°€ ì¡´ì¬í•˜ì—¬ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•˜ìœ„ ì¹´í…Œê³ ë¦¬ë¥¼ ë¨¼ì € ì‚­ì œí•´ì£¼ì„¸ìš”.');
          closeDeleteModal();
          return;
        }
      }
      
      // ì‹¤ì œ ì‚­ì œ ìˆ˜í–‰
      categories = categories.filter(cat => cat.groupId != deleteId);
      localStorage.setItem('categories', JSON.stringify(categories));
      buildCategoryTree();
      displayCategories();
      updateStats();
      closeDeleteModal();
      
      alert('ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
      const categoryModal = document.getElementById('categoryModal');
      const deleteModal = document.getElementById('deleteModal');
      
      if (event.target === categoryModal) {
        closeCategoryModal();
      }
      if (event.target === deleteModal) {
        closeDeleteModal();
      }
    }

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeCategoryModal();
        closeDeleteModal();
      }
    });
  </script>
</body>
</html>