<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¬ê³ ê´€ë¦¬ì‹œìŠ¤í…œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-value { font-size: 32px; font-weight: bold; color: #2c3e50; }
        .stat-label { color: #7f8c8d; margin-top: 5px; }
        .critical { color: #e74c3c; }
        .warning { color: #f39c12; }
        .good { color: #27ae60; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .search-box { padding: 10px; border: 1px solid #ddd; border-radius: 5px; flex: 1; max-width: 300px; }
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .table th { background: #f8f9fa; font-weight: 600; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .nav-home { position: fixed; top: 20px; right: 20px; background: #3498db; color: white; padding: 10px 15px; border-radius: 25px; text-decoration: none; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 8px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 20px; border-radius: 5px; color: white; z-index: 1001; display: none; }
        .notification.success { background: #27ae60; }
        .notification.error { background: #e74c3c; }
        .notification.warning { background: #f39c12; }
    </style>
</head>
<body>
    <a href="../integrated-system/" class="nav-home">ğŸ  í†µí•© ëŒ€ì‹œë³´ë“œ</a>
    
    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ“¦ ì¬ê³ ê´€ë¦¬ì‹œìŠ¤í…œ</h1>
                <p>ì‹¤ì‹œê°„ ì¬ê³  í˜„í™© ëª¨ë‹ˆí„°ë§ ë° ê´€ë¦¬</p>
            </div>
            <div>
                <button class="btn btn-success" onclick="openAddModal()">+ ì¬ê³  ì¡°ì •</button>
                <button class="btn btn-primary" onclick="generateReport()">ğŸ“Š ë³´ê³ ì„œ</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value critical" id="criticalItems">0</div>
                <div class="stat-label">ìœ„í—˜ ì¬ê³  í’ˆëª©</div>
            </div>
            <div class="stat-card">
                <div class="stat-value warning" id="lowStockItems">0</div>
                <div class="stat-label">ë‚®ì€ ì¬ê³  í’ˆëª©</div>
            </div>
            <div class="stat-card">
                <div class="stat-value good" id="normalItems">0</div>
                <div class="stat-label">ì •ìƒ ì¬ê³  í’ˆëª©</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalValue">â‚©0</div>
                <div class="stat-label">ì´ ì¬ê³  ê°€ì¹˜</div>
            </div>
        </div>

        <div class="section">
            <h3>ğŸ“‹ ì¬ê³  í˜„í™©</h3>
            <div class="controls">
                <input type="text" class="search-box" placeholder="í’ˆëª©ëª… ë˜ëŠ” ì½”ë“œë¡œ ê²€ìƒ‰..." id="searchInput">
                <select id="statusFilter" class="search-box" style="max-width: 150px;">
                    <option value="">ì „ì²´ ìƒíƒœ</option>
                    <option value="critical">ìœ„í—˜ ì¬ê³ </option>
                    <option value="low">ë‚®ì€ ì¬ê³ </option>
                    <option value="normal">ì •ìƒ ì¬ê³ </option>
                    <option value="excess">ê³¼ë‹¤ ì¬ê³ </option>
                </select>
                <button class="btn btn-primary" onclick="exportToExcel()">Excel ë‚´ë³´ë‚´ê¸°</button>
            </div>
            
            <table class="table" id="inventoryTable">
                <thead>
                    <tr>
                        <th>í’ˆëª©ì½”ë“œ</th>
                        <th>í’ˆëª©ëª…</th>
                        <th>ì¹´í…Œê³ ë¦¬</th>
                        <th>í˜„ì¬ì¬ê³ </th>
                        <th>ì•ˆì „ì¬ê³ </th>
                        <th>ìƒíƒœ</th>
                        <th>ìœ„ì¹˜</th>
                        <th>ë‹¨ê°€</th>
                        <th>ì¬ê³ ê°€ì¹˜</th>
                        <th>ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- ì¬ê³  ì¡°ì • ëª¨ë‹¬ -->
    <div id="adjustModal" class="modal">
        <div class="modal-content">
            <h3>ì¬ê³  ì¡°ì •</h3>
            <form id="adjustForm">
                <div class="form-group">
                    <label>í’ˆëª©ì„ íƒ</label>
                    <select id="itemSelect" required>
                        <option value="">í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ì¡°ì •ìœ í˜•</label>
                    <select id="adjustType" required>
                        <option value="in">ì…ê³ </option>
                        <option value="out">ì¶œê³ </option>
                        <option value="adjust">ì¬ê³ ì¡°ì •</option>
                        <option value="damage">ì†ì‹¤/íŒŒì†</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ì¡°ì •ìˆ˜ëŸ‰</label>
                    <input type="number" id="adjustQty" required min="1">
                </div>
                <div class="form-group">
                    <label>ì‚¬ìœ </label>
                    <input type="text" id="adjustReason" placeholder="ì¡°ì • ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="controls">
                    <button type="submit" class="btn btn-success">ì¡°ì • ì™„ë£Œ</button>
                    <button type="button" class="btn" onclick="closeModal()">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <!-- í†µí•© ì‹œìŠ¤í…œ ì—°ë™ -->
    <script src="../integrated-system/core/data-manager.js"></script>
    <script src="../integrated-system/core/schema-manager.js"></script>
    <script src="../integrated-system/adapters/legacy-integration.js"></script>
    
    <script>
        class InventorySystem {
            constructor() {
                this.dataManager = window.DataManager;
                this.init();
            }

            init() {
                this.loadInventoryData();
                this.setupEventListeners();
                this.updateStats();
                this.renderTable();
                this.setupSearch();
            }

            loadInventoryData() {
                const items = this.dataManager.getData('items') || [];
                const inventory = this.dataManager.getData('inventory') || [];
                
                // í’ˆëª© ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¬ê³  ë°ì´í„° ìƒì„±
                if (items.length > 0 && inventory.length === 0) {
                    const inventoryData = items.map(item => ({
                        itemCode: item.itemCode,
                        itemName: item.itemName,
                        category: item.category1st || 'ê¸°íƒ€',
                        currentStock: Math.floor(Math.random() * 200) + 10,
                        safetyStock: 20,
                        maxStock: 500,
                        location: `A-${String(Math.floor(Math.random() * 10) + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 10) + 1).padStart(2, '0')}`,
                        unitPrice: item.unitPrice || 10000,
                        lastUpdated: new Date().toISOString()
                    }));
                    
                    this.dataManager.setData('inventory', inventoryData);
                }
            }

            setupEventListeners() {
                document.getElementById('adjustForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.processAdjustment();
                });

                document.getElementById('searchInput').addEventListener('input', () => this.renderTable());
                document.getElementById('statusFilter').addEventListener('change', () => this.renderTable());
            }

            setupSearch() {
                const items = this.dataManager.getData('items') || [];
                const select = document.getElementById('itemSelect');
                select.innerHTML = '<option value="">í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.itemCode;
                    option.textContent = `${item.itemCode} - ${item.itemName}`;
                    select.appendChild(option);
                });
            }

            updateStats() {
                const inventory = this.dataManager.getData('inventory') || [];
                
                let critical = 0, low = 0, normal = 0, totalValue = 0;
                
                inventory.forEach(item => {
                    const stock = item.currentStock;
                    const safety = item.safetyStock;
                    const value = stock * (item.unitPrice || 0);
                    
                    totalValue += value;
                    
                    if (stock <= safety * 0.5) critical++;
                    else if (stock <= safety) low++;
                    else normal++;
                });

                document.getElementById('criticalItems').textContent = critical;
                document.getElementById('lowStockItems').textContent = low;
                document.getElementById('normalItems').textContent = normal;
                document.getElementById('totalValue').textContent = `â‚©${totalValue.toLocaleString()}`;
            }

            getStockStatus(current, safety) {
                if (current <= safety * 0.5) return 'critical';
                if (current <= safety) return 'low';
                if (current > safety * 3) return 'excess';
                return 'normal';
            }

            getStatusBadge(status) {
                const badges = {
                    critical: '<span class="status-badge" style="background:#e74c3c;color:white">ìœ„í—˜</span>',
                    low: '<span class="status-badge" style="background:#f39c12;color:white">ë‚®ìŒ</span>',
                    normal: '<span class="status-badge" style="background:#27ae60;color:white">ì •ìƒ</span>',
                    excess: '<span class="status-badge" style="background:#3498db;color:white">ê³¼ë‹¤</span>'
                };
                return badges[status] || badges.normal;
            }

            renderTable() {
                const inventory = this.dataManager.getData('inventory') || [];
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;
                
                const filtered = inventory.filter(item => {
                    const matchesSearch = item.itemName.toLowerCase().includes(searchTerm) || 
                                        item.itemCode.toLowerCase().includes(searchTerm);
                    const status = this.getStockStatus(item.currentStock, item.safetyStock);
                    const matchesStatus = !statusFilter || status === statusFilter;
                    
                    return matchesSearch && matchesStatus;
                });

                const tbody = document.getElementById('inventoryTableBody');
                tbody.innerHTML = filtered.map(item => {
                    const status = this.getStockStatus(item.currentStock, item.safetyStock);
                    const value = item.currentStock * item.unitPrice;
                    
                    return `
                        <tr>
                            <td>${item.itemCode}</td>
                            <td>${item.itemName}</td>
                            <td>${item.category}</td>
                            <td>${item.currentStock}</td>
                            <td>${item.safetyStock}</td>
                            <td>${this.getStatusBadge(status)}</td>
                            <td>${item.location}</td>
                            <td>â‚©${item.unitPrice.toLocaleString()}</td>
                            <td>â‚©${value.toLocaleString()}</td>
                            <td>
                                <button class="btn btn-primary" style="padding:5px 10px;font-size:12px" onclick="inventory.quickAdjust('${item.itemCode}')">ì¡°ì •</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            quickAdjust(itemCode) {
                document.getElementById('itemSelect').value = itemCode;
                openAddModal();
            }

            processAdjustment() {
                const itemCode = document.getElementById('itemSelect').value;
                const adjustType = document.getElementById('adjustType').value;
                const qty = parseInt(document.getElementById('adjustQty').value);
                const reason = document.getElementById('adjustReason').value;

                const inventory = this.dataManager.getData('inventory') || [];
                const itemIndex = inventory.findIndex(item => item.itemCode === itemCode);
                
                if (itemIndex === -1) {
                    this.showNotification('í’ˆëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                let adjustment = 0;
                switch(adjustType) {
                    case 'in': adjustment = qty; break;
                    case 'out': adjustment = -qty; break;
                    case 'adjust': adjustment = qty - inventory[itemIndex].currentStock; break;
                    case 'damage': adjustment = -qty; break;
                }

                inventory[itemIndex].currentStock += adjustment;
                inventory[itemIndex].lastUpdated = new Date().toISOString();

                // ì´ë ¥ ì €ì¥
                const history = this.dataManager.getData('inventoryHistory') || [];
                history.push({
                    itemCode,
                    type: adjustType,
                    quantity: qty,
                    adjustment,
                    reason,
                    beforeStock: inventory[itemIndex].currentStock - adjustment,
                    afterStock: inventory[itemIndex].currentStock,
                    timestamp: new Date().toISOString()
                });

                this.dataManager.setData('inventory', inventory);
                this.dataManager.setData('inventoryHistory', history);

                this.updateStats();
                this.renderTable();
                closeModal();
                this.showNotification('ì¬ê³  ì¡°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }

            showNotification(message, type) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }

            generateReport() {
                const inventory = this.dataManager.getData('inventory') || [];
                const report = {
                    generatedAt: new Date().toISOString(),
                    summary: {
                        totalItems: inventory.length,
                        criticalItems: inventory.filter(i => this.getStockStatus(i.currentStock, i.safetyStock) === 'critical').length,
                        lowStockItems: inventory.filter(i => this.getStockStatus(i.currentStock, i.safetyStock) === 'low').length,
                        totalValue: inventory.reduce((sum, i) => sum + (i.currentStock * i.unitPrice), 0)
                    },
                    details: inventory
                };
                
                this.downloadJson(report, 'ì¬ê³ í˜„í™©ë³´ê³ ì„œ.json');
                this.showNotification('ë³´ê³ ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }

            downloadJson(data, filename) {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        function openAddModal() {
            document.getElementById('adjustModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('adjustModal').style.display = 'none';
            document.getElementById('adjustForm').reset();
        }

        function exportToExcel() {
            inventory.showNotification('Excel ë‚´ë³´ë‚´ê¸° ì¤€ë¹„ ì¤‘...', 'success');
        }

        // ì „ì—­ ë³€ìˆ˜ë¡œ ì‹œìŠ¤í…œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        let inventory;
        
        // DOM ë¡œë“œ í›„ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            inventory = new InventorySystem();
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const modal = document.getElementById('adjustModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>